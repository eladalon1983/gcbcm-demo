<html>
  <head>
    <meta charset="utf-8" />
    <meta name="mobile-web-app-capable" content="no" />
    <meta
      http-equiv="origin-trial"
      content="AqHueJjojXilmpAO03Hk+c4cMmK0ts1m20RpGDutQOyb68KsKOPVQ3UyfWaSNVt068dfPcHTtYVvQkbF9JBuKwMAAABueyJvcmlnaW4iOiJodHRwczovL2VsYWRhbG9uMTk4My5naXRodWIuaW86NDQzIiwiZmVhdHVyZSI6IkdldEN1cnJlbnRCcm93c2luZ0NvbnRleHRNZWRpYSIsImV4cGlyeSI6MTYyOTg0OTU5OX0="
    />
    <link rel="icon" href="#" />
    <title>get-current-tab</title>
  </head>
  <body>
    <div id="container">
      <h1>
        <span>Capture-Current-Tab</span>
      </h1>
      <p>Expect the Hall of Mirrors effect.</p>
      <video id="video" autoplay playsinline></video>
      <canvas id="canvas"></canvas>
      <br />
      <button onclick="videoClicked();">Capture video</button>
      <button onclick="screenshotClicked();">Capture screenshot</button>
      <div id="errorMsg" style="color: red"></div>
      <p>
        Display the video stream from
        <code>getCurrentBrowsingContextMedia()</code> in a video element.
      </p>
    </div>
    <script>
      function drawCanvas(canvas, img) {
        canvas.width = window.innerWidth / 2;
        canvas.height = window.innerHeight / 2;
        console.log(`canvas.width = ${canvas.width}, canvas.height = ${canvas.height}`);
        let ratio = Math.min(canvas.width / img.width, canvas.height / img.height);
        let x = (canvas.width - img.width * ratio) / 2;
        let y = (canvas.height - img.height * ratio) / 2;
        canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
        canvas
          .getContext("2d")
          .drawImage(img, 0, 0, img.width, img.height, x, y, img.width * ratio, img.height * ratio);
      }

      async function videoClicked(e) {
        document.querySelector("#errorMsg").innerHTML = "";
        try {
          const stream = await navigator.mediaDevices.getCurrentBrowsingContextMedia();
          document.querySelector("video").srcObject = stream;
        } catch (e) {
          document.querySelector("#errorMsg").innerHTML += `<p>getUserMedia error: ${e.name}</p>`;
        }
      }

      async function screenshotClicked(e) {
        document.querySelector("#errorMsg").innerHTML = "";
        try {
          const stream = await navigator.mediaDevices.getCurrentBrowsingContextMedia();
          let track = stream.getVideoTracks()[0];
          let imageCapture = new ImageCapture(track);
          imageCapture.grabFrame().then((imageBitmap) => {
            drawCanvas(document.getElementById("canvas"), imageBitmap);
            track.stop();
          });
        } catch (e) {
          document.querySelector("#errorMsg").innerHTML += `<p>getUserMedia error: ${e.name}</p>`;
        }
      }
    </script>
  </body>
</html>
