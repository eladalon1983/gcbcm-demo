<html>
  <head>
    <meta charset="utf-8" />
    <meta name="mobile-web-app-capable" content="no" />
    <meta
      http-equiv="origin-trial"
      content="AqHueJjojXilmpAO03Hk+c4cMmK0ts1m20RpGDutQOyb68KsKOPVQ3UyfWaSNVt068dfPcHTtYVvQkbF9JBuKwMAAABueyJvcmlnaW4iOiJodHRwczovL2VsYWRhbG9uMTk4My5naXRodWIuaW86NDQzIiwiZmVhdHVyZSI6IkdldEN1cnJlbnRCcm93c2luZ0NvbnRleHRNZWRpYSIsImV4cGlyeSI6MTYyOTg0OTU5OX0="
    />
    <link rel="icon" href="#" />
    <style>
      body {
        font-family: "HelveticaNeue-Light", "Helvetica Neue Light", "Helvetica Neue", Helvetica,
          Arial, "Lucida Grande", sans-serif;
        font-weight: 300;
      }

      #container {
        text-align: center;
      }

      p {
        display: inline-block;
        width: 30%;
        text-align: left;
      }

      h1 + p,
      h2 {
        text-align: center;
      }

      button {
        padding: 12px;
        border-radius: 6px;
        border: none;
        background: #1a73e8;
        color: #fff;
        letter-spacing: 0.2px;
        margin: 16px;
      }
    </style>
    <title>get-current-tab</title>
  </head>
  <body>
    <div id="container">
      <h1>
        <span>Capture-Current-Tab</span>
      </h1>
      <p>
        This is a demo about the difference between getDisplayMedia (the old API) adipisicing the
        get-current-tab API. The latter yield a much more appropriate media-picker if the current
        tab is the intended capture target.
      </p>
      <div id="div">
        <video id="video" autoplay playsinline hidden style="border: solid"></video>
        <canvas id="canvas" hidden style="border: solid"></canvas>
      </div>
      <br />
      <h2 id="clarification">The video/screenshot will appear here.</h2>
      <br />
      <button onclick="screenshotClicked();">Capture screenshot</button>
      <button onclick="videoClicked('new');">Capture video</button>
      <button onclick="videoClicked('old');">Old API</button>
      <div id="errorMsg" style="color: red"></div>
      <p>
        Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt
        ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco
        laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in
        voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat
        cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
      </p>
      <p>
        Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt
        ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco
        laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in
        voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat
        cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
      </p>
      <p>
        Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt
        ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco
        laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in
        voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat
        cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
      </p>
    </div>
    <script>
      let canvas = document.getElementById("canvas");
      let video = document.getElementById("video");
      let div = document.getElementById("div");
      let clarification = document.getElementById("clarification");
      let errorMsg = document.getElementById("errorMsg");

      function drawCanvas(canvas, img) {
        canvas.width = window.innerWidth / 2;
        canvas.height = window.innerHeight / 2;
        console.log(`canvas.width = ${canvas.width}, canvas.height = ${canvas.height}`);
        let ratio = Math.min(canvas.width / img.width, canvas.height / img.height);
        let x = (canvas.width - img.width * ratio) / 2;
        let y = (canvas.height - img.height * ratio) / 2;
        canvas.getContext("2d").clearRect(0, 0, canvas.width, canvas.height);
        canvas
          .getContext("2d")
          .drawImage(img, 0, 0, img.width, img.height, x, y, img.width * ratio, img.height * ratio);
      }

      function reset() {
        canvas.hidden = true;
        video.hidden = true;
        if (video.srcObject) {
          video.srcObject.getVideoTracks()[0].stop();
        }
        errorMsg.innerHTML = "";
        clarification.innerHTML = "The video/screenshot will appear here.";
      }

      async function screenshotClicked(e) {
        reset();
        let stream;
        try {
          stream = await navigator.mediaDevices.getCurrentBrowsingContextMedia();
        } catch (e) {
          errorMsg.innerHTML += `<p>getUserMedia error: ${e.name}</p>`;
          return;
        }

        clarification.innerHTML = "";
        let track = stream.getVideoTracks()[0];
        let imageCapture = new ImageCapture(track);
        imageCapture.grabFrame().then((imageBitmap) => {
          drawCanvas(canvas, imageBitmap);
          canvas.hidden = false;
          track.stop();
        });
      }

      async function videoClicked(e, version) {
        reset();
        let stream;
        try {
          stream =
            version == "new"
              ? await navigator.mediaDevices.getCurrentBrowsingContextMedia()
              : await navigator.mediaDevices.getDisplayMedia();
        } catch (e) {
          errorMsg.innerHTML += `<p>getUserMedia error: ${e.name}</p>`;
          return;
        }
        clarification.innerHTML = "";
        video.srcObject = stream;
        video.width = window.innerWidth / 2;
        video.height = window.innerHeight / 2;
        video.hidden = false;
      }

      div.width = window.innerWidth / 2;
      div.height = window.innerHeight / 2;
    </script>
  </body>
</html>
